---
output:
  knitrBootstrap::bootstrap_document:
    theme.chooser: TRUE
    highlight.chooser: TRUE
---

<!--
%\VignetteEngine{knitr::rmarkdown}
%\VignetteIndexEntry{Example 8}
%\VignetteDepends{xtable}
-->


# Example 8 -  Sliding Time Window #
<br>
Goal: Detect frequency changes in a time varying signal
<br>
```{r, eval=TRUE, results='asis'}
frequencyChangeDS = getData("frequencyChange")
timeWindow = 30 # time window to examine
print(xtable(head(frequencyChangeDS,n=5)), type='html', comment=F)
```
<br>
Let's take a look at time windows before failures and non-failure:
```{r, eval=TRUE, results='asis'}
failures = which(frequencyChangeDS$failure==1)
par(mfrow=c(4,1))
plot(frequencyChangeDS[(failures[20]-timeWindow):failures[20],]$signal1,type="l",ylab=NA,main = "Failure")
plot(frequencyChangeDS[(failures[5000]-timeWindow):failures[5000],]$signal1,type="l",ylab=NA,main = "Failure")
plot(frequencyChangeDS[(failures[1]-timeWindow-500):(failures[1]-500),]$signal1,type="l",ylab=NA,main = "Non-Failure")
plot(frequencyChangeDS[(failures[1]-timeWindow-1000):(failures[1]-1000),]$signal1,type="l",ylab=NA,main = "Non-Failure")
```
<br>
The differences are clearest in the frequency domain:
```{r, eval=TRUE, results='asis'}
par(mfrow=c(4,2))
plot(frequencyChangeDS[(failures[20]-timeWindow):failures[20],]$signal1,type="l",ylab=NA,main = "Failure")
plot(abs(fft(frequencyChangeDS[(failures[20]-timeWindow):failures[20],]$signal1))[2:(timeWindow/2)],ylab=NA,type="l",main = "Frequency domain")
plot(frequencyChangeDS[(failures[5000]-timeWindow):failures[5000],]$signal1,type="l",ylab=NA,main = "Failure")
plot(abs(fft(frequencyChangeDS[(failures[5000]-timeWindow):failures[5000],]$signal1))[2:(timeWindow/2)],ylab=NA,type="l",main = "Frequency domain")
plot(frequencyChangeDS[(failures[1]-timeWindow-500):(failures[1]-500),]$signal1,type="l",ylab=NA,main = "Non-Failure")
plot(abs(fft(frequencyChangeDS[(failures[1]-timeWindow-500):(failures[1]-500),]$signal1))[2:(timeWindow/2)],ylab=NA,type="l",main = "Frequency domain")
plot(frequencyChangeDS[(failures[1]-timeWindow-1000):(failures[1]-1000),]$signal1,type="l",ylab=NA,main = "Non-Failure")
plot(abs(fft(frequencyChangeDS[(failures[1]-timeWindow-1000):(failures[1]-1000),]$signal1))[2:(timeWindow/2)],ylab=NA,type="l",main = "Frequency domain")


```
<br>
The failures are characteried by wider band signals and higher frequency ranges
<br><br>
In order to model this particular problem the features need to be represented as a windowed time series:
```{r, eval=TRUE, results='asis'}
frequencyChangeDSwindowed = addSlidingTimeWindow(frequencyChangeDS, "date", timeWindow, "day",dateFormat = "%a %b %d %H:%M:%S %z %Y",relativeTime=FALSE)
print(xtable(head(frequencyChangeDSwindowed,n=5)), type='html', comment=F)
```

<br>
Now that we have the sliding window column prepared we will split the data temporally to a testing and training set. We will retain only the target and time window information (including the date) in the training and testing data and access the actual signal (and any other columns) in a context dataset (date will serve as a key)
```{r, eval=TRUE, results='asis'}
temporalSplit = failures[round(length(failures)*0.6)]
trainData = frequencyChangeDSwindowed[1:temporalSplit,c("date","failure",paste0("last_",timeWindow))] # keep only date, target and sliding window parameters
testData = frequencyChangeDSwindowed[(temporalSplit+1):nrow(frequencyChangeDSwindowed),c("date","failure",paste0("last_",timeWindow))] # keep only date, target and sliding window parameters
contextData = frequencyChangeDSwindowed[,c("date","signal1")] # keep only the key (date in our case) and all other signals/columns
```

```{r frequency_change_example, eval=TRUE, message=FALSE, results='hide'}
contextDataPth = writeToServer(contextData)
frequencyModel = learn(projectName = "frequency_change_example",
                        functionsBlackList = list("Tuple2","date"),
                        trainData = trainData,
                        testData = testData,
                        target = "failure",
                        algorithmsWhiteList = list("RRandomForestClassifier"),  
                        maxFeaturesCount = 50,                        
                        contextDatasets = list(contextDataPth),
                        autoSave = FALSE,maxDepth = 3
                    )
frequencyModelEval = frequencyModel$evaluate()
```

The model finds the exact anomolies causing the failure: frequency content outside the range of the carrier signal as well as gradient and slope changes.
```{r, eval=TRUE, results='asis'}
library(xtable)
print(xtable(frequencyModel$features()[1:5,c("idx","feature")]), type='html', comment=F) 
writeLines(gsub("\n","<br>",frequencyModelEval$evaluation$summary))
```

