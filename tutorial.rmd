---
title: "SparkBeyond R plugin tutorial"
author: "Guy Zinman"
date: "March 25, 2015"
output: html_document
---
This tutorial explains the basics of how to use the **R SparkBeyond plugin**.

For this tutorial we will use titanic as an example.

### Installation

We will first install and load the SBadatper plugin: <!-- eval should always be FALSE here. I set eval = FALSE with spaces so that it won't be found in replace all --> 
```{r, eval = FALSE}
library('devtools')
install_github('zinman/SBadapter')
library('SBadapter')
```
```{r, echo=FALSE}
library('SBadapter')
```

### Loading data

As example datasets we added titanic train and test datasets to this package. We will first use an auxiliary function named 'getTitanicFilename' to retrieve the path to the train file (and also to the test file for a later use):
```{r}
train_file_path = getTitanicFilename(train = TRUE)
test_file_path = getTitanicFilename(train = FALSE)
```

### Feature search + Model building
We can now send this file (or alternatively a file of your choice for training). 
The necessary parameters are: 

1.  `sessionName` - a name describring the analysis
2.  `training file path` - the path to the training file
3.  `target` - the column name in the input data that denotes the label you want to learn

In order to expedite this run, we are limiting the algorithms to be used to R's RandomForest algorithm. There are many other parameters that can be defined in the learning process and they are detailed in the SBadapter help. <!-- PUT LINK TO HELP HERE --> 

```{r, eval=TRUE}
model = SBlearn(sessionName = "titanic",
                        trainingFilePath = train_file_path,
                        target = "survived",
                        algorithmsWhiteList = list("RRandomForest"))
```
The returned object encapsulates a model on which we can perform various operations listed in the help for the SBmodel class. We will demonstrate below some of them.

### Enriching a dataset

We will now show how to enrich an external dataset (e.g, our holdout test titanic data) using SparkBeyond features that were automatically generated in the model above. The parameters are:

1.  `datapath` - the path to the test file
2.  `outputPath` - the path to where the output should be written to
3.  `featureCount` - the number of features to get back (use NA for all, in this example we request only the top 10)

```{r,  eval=TRUE}
enriched = model$enrich(dataPath = test_file_path, 
             outputPath = paste(getwd(),"titanic_test_enriched.tsv.gz",sep="/"), 
             featureCount=10)
colnames(enriched)
```
As you see we got the 10 original columns + 10 more columns generated by the model. The new columns have standardized names and we will short see how get more information on the new features.

### Making a prediction
We will now show how to apply the model on an external dataset (e.g, our holdout test titanic data). The parameters are: 

1.  `datapath` - the path to the test file
2.  `outputPath` - the path to where the output should be written to
```{r,  eval=TRUE}
predicted = model$predict(dataPath = test_file_path, 
             outputPath = paste(getwd(),"titanic_test_predicted.tsv.gz",sep="/"))
colnames(predicted)
predicted[1:5,c("survived_predicted", "X_0_probability", "X_1_probability")]
```
As we can see we got back 3 additional columns, one indicating the final prediction, and two columns indicated the probability for getting the class "0" and class "1" of the survival state.

### Model evaluation
Calling `evaluate` on `model` will produce a short text report on the results of the model. In addition the return object contains addtional evaluation metrics available to the user.
```{r,  eval=TRUE}
eval = model$evaluate()
```

### Reports
There are numerous reports that can be call on the results of a model and the user. These are HTML reports and will show either in the RStudio viewer pane or in an external browser. The reports divide to reports that provide information regarding the feature search process, including:

* `showInputSchema` - will show the list of fields that were sent to the feature search process, including types, cardinality and more
* `showFeatures` - will show features that were generated by the feature search process including statics on the performance of each one. 
* `showFields` - will show fields from which features were generated 
* `showFunctions` - will show functions used in the features that were created
* `showExtractors` - will show extractors used in the features that were created

and reports that provide information regarding the modeling process, including:

* `showROC` - will plot in the browser the ROC of the model that was generated
* `showConfusionMatrix` - will show the confusion matrix table (option for the normalized version)
* `showROC_CV` - will plot in the browser the ROC of the various algorithms that were tried
* `showModelComparison` - will provide a table summarizing the CV results for the different algorithms

Here are some examples of reports:

**Features**
```{r,  eval = FALSE}
model$showFeatures()
```
should look like this:
<iframe width="900" height="400" src="https://3ceaeb28a951bf57d68ca32211bb4c98dd31f5fc.googledrive.com/host/0Byt-OjYvY171fnJIS25JTmZxQ2RqMzc5dlFQZTNiaVZ1bXpqWGxiRDVsSWlzTEpUbU5lMjg/SB_Rplugin/img/features.html"  frameborder="0" seamless></iframe>

**Confusion matrix**
```{r,  eval = FALSE}
model$showConfusionMatrix()
```
should look like this:
<iframe width="400" height="400" src="https://3ceaeb28a951bf57d68ca32211bb4c98dd31f5fc.googledrive.com/host/0Byt-OjYvY171fnJIS25JTmZxQ2RqMzc5dlFQZTNiaVZ1bXpqWGxiRDVsSWlzTEpUbU5lMjg/SB_Rplugin/img/confusionMatrix.html"  frameborder="0" seamless></iframe>

**ROC plot**
```{r,  eval = FALSE}
model$showROC()
```
should look like this:
<iframe width="1000" height="800" src="https://3ceaeb28a951bf57d68ca32211bb4c98dd31f5fc.googledrive.com/host/0Byt-OjYvY171fnJIS25JTmZxQ2RqMzc5dlFQZTNiaVZ1bXpqWGxiRDVsSWlzTEpUbU5lMjg/SB_Rplugin/img/roc_best.html"  frameborder="0" seamless></iframe>

### Performing feature search only
This is very similar to the the `SBlearn` call but will preform only the feature selection phase. In this mode, the user will be able to call `evaluate` but will get an exception calling `predict`. In edition, some of the reports pertaining to the model results (e.g., `showROC` and `showConfusionMatrix`) will not be available.  

```{r, eval = FALSE}
model = SBfeatureSearchOnly(sessionName = "titanic",
                        trainingFilePath = train_file_path,
                        target = "survived")
```
