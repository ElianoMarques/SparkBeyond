---
title: "SparkBeyond R plugin tutorial"
output: html_document
---
This tutorial explains how to use **R SparkBeyond plugin**.

### Installation

Install and load the SBadatper plugin 

<!-- 
  Comment:
  ========
  eval should always be FALSE here. I set eval = FALSE with spaces so that it won't be found in replace all 
--> 
  
```{r, eval = FALSE}
library('devtools')
install_github('zinman/SBadapter')
library('SBadapter')
```
```{r, echo=FALSE}
library('SBadapter')
```

### Feature search + Model building

`SBlearn` is used to discover features & build a model, it requires the following input:

1.  `sessionName`         - a name describring the analysis  
2.  `training file path`  - the path to the training file (text file, comma or tab separated)
3.  `target`              - the column name in the input data denoting the label to learn

<!--  
  Comment:
  ========
  in order for this to work we need to get the titanic file path using:
  train_file_path = getTitanicFilename(train = TRUE)
--> 

```{r, eval=FALSE}
model = SBlearn(sessionName = "titanic",
                        trainingFilePath = train_file_path,
                        target = "survived",
                        algorithmsWhiteList = list("RRandomForest"))
```

The returned object `model` encapsulates a predictive-model on which we can perform various operations listed in the help for the SBmodel class. 

### Enriching a dataset

`enrich` is used to calculate & add new features from a `model` to a `dataset`, it requires the following input:

1.  `datapath`      - data-file path (typically a test-set)
2.  `outputPath`    - output file path
3.  `featureCount`  - number of features  (use NA to get all features)

```{r,  eval=FALSE}
enriched = model$enrich(dataPath = test_file_path, 
             outputPath = paste(getwd(),"titanic_test_enriched.tsv.gz",sep="/"), 
             featureCount=10)
```

Each features is added to the dataset as a new columns

```{r,  eval=FALSE}
colnames(enriched)
```

As you see we now have 10 original *titanic* columns + 10 additional columns generated by the model. 

<!--  
  Comment:
  ========
  in order for this to work we need to get the titanic file path using:
  test_file_path = getTitanicFilename(train = FALSE)  
--> 

### Making a prediction

`predict` is used to calculate predicted-values for `target` based on a `model` applied to a `dataset`, 

it requires the following input:

1.  `datapath`   - data-file path (typically a test-set)
2.  `outputPath` - output file path

```{r,  eval=FALSE}
predicted = model$predict(dataPath = test_file_path, 
             outputPath = paste(getwd(),"titanic_test_predicted.tsv.gz",sep="/"))
```

The resulting prediction is added to the dataset as a set of new columns

```{r,  eval=FALSE}
colnames(predicted)
predicted[1:5,c("survived_predicted", "X_0_probability", "X_1_probability")]
```

We now have 3 additional columns:

1. final prediction
2. probability of class "0"
3. probability of class "1"

### Model evaluation

`evaluate` summarizes `model` results in a short textual report. 

```{r,  eval=FALSE}
eval = model$evaluate()
```
It also returns an `eval` object containing evaluation metrics.


### Reports

A rich set of pre-defined reports is available for model analysis. 
These are HTML reports and will show either in the RStudio viewer pane or in an external browser. 

#### Data & Features
* `showInputSchema` - Schema of the dataset sent for modeling
* `showFeatures` - Features discovered by the system in the learning process 
* `showFields` - Fields from which features were generated 
* `showFunctions` - Transformations used to generate the features
* `showExtractors` - will show extractors used in the features that were created

#### Model
* `showROC` - ROC plot
* `showConfusionMatrix` - Confusion matrix  (option for the normalized version)
* `showROC_CV` - combined ROC plot for of the various algorithms that were tried
* `showModelComparison` - Comparison evaluation table of the various algorithms that were tried

Here are a a few examples:

**Features**
```{r,  eval = FALSE}
model$showFeatures()
```
<iframe width="900" height="400" src="https://3ceaeb28a951bf57d68ca32211bb4c98dd31f5fc.googledrive.com/host/0Byt-OjYvY171fnJIS25JTmZxQ2RqMzc5dlFQZTNiaVZ1bXpqWGxiRDVsSWlzTEpUbU5lMjg/SB_Rplugin/img/features.html"  frameborder="0" seamless></iframe>

**Confusion matrix**
```{r,  eval = FALSE}
model$showConfusionMatrix()
```
<iframe width="400" height="400" src="https://3ceaeb28a951bf57d68ca32211bb4c98dd31f5fc.googledrive.com/host/0Byt-OjYvY171fnJIS25JTmZxQ2RqMzc5dlFQZTNiaVZ1bXpqWGxiRDVsSWlzTEpUbU5lMjg/SB_Rplugin/img/confusionMatrix.html"  frameborder="0" seamless></iframe>

**ROC plot**
```{r,  eval = FALSE}
model$showROC()
```
<iframe width="1000" height="800" src="https://3ceaeb28a951bf57d68ca32211bb4c98dd31f5fc.googledrive.com/host/0Byt-OjYvY171fnJIS25JTmZxQ2RqMzc5dlFQZTNiaVZ1bXpqWGxiRDVsSWlzTEpUbU5lMjg/SB_Rplugin/img/roc_best.html"  frameborder="0" seamless></iframe>

### Performing feature search only
There is an option to perform only feature extraction at the learning stage using `SBfeatureSearchOnly`

```{r, eval = FALSE}
model = SBfeatureSearchOnly(sessionName = "titanic",
                        trainingFilePath = train_file_path,
                        target = "survived")
```
In this case, the user will be able to call `evaluate` but will get an exception calling `predict`.
In edition, some of the reports pertaining to the model results (e.g., `showROC` and `showConfusionMatrix`) will not be available.  

